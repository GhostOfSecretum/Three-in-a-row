export type LevelDefinition = {
  name: string;
  map: string[];
  playerStart: { x: number; y: number; angle: number };
  enemies: Array<{ x: number; y: number }>;
};

export type ParsedLevel = {
  name: string;
  tiles: number[][];
  width: number;
  height: number;
  exitTiles: Set<string>;
  playerStart: { x: number; y: number; angle: number };
  enemies: Array<{ x: number; y: number }>;
};

// Alien Shooter стиль - большие открытые арены с укрытиями
const LEVELS: LevelDefinition[] = [
  {
    name: 'Warehouse Alpha',
    map: [
      '11111111111111111111111111111111',
      '1..............................1',
      '1..11..11....11....11..11......1',
      '1..11..11....11....11..11......1',
      '1..............................1',
      '1............22................1',
      '1....11......22......11........1',
      '1....11..............11........1',
      '1..............................1',
      '1..........33..33..............1',
      '1..........33..33..............1',
      '1..............................1',
      '1....22..............22........1',
      '1....22......44......22........1',
      '1............44................1',
      '1..............................1',
      '1..11..11....11....11..11......1',
      '1..11..11....11....11..11......1',
      '1..............................1',
      '1.......................E......1',
      '11111111111111111111111111111111',
    ],
    playerStart: { x: 2, y: 2, angle: 0 },
    enemies: [],
  },
  {
    name: 'Research Lab',
    map: [
      '22222222222222222222222222222222',
      '2..............................2',
      '2..1111111......1111111........2',
      '2..1.....1......1.....1........2',
      '2..1.....1......1.....1........2',
      '2..1111111......1111111........2',
      '2..............................2',
      '2..............................2',
      '2........3333333333............2',
      '2........3........3............2',
      '2........3........3............2',
      '2........3........3............2',
      '2........3333333333............2',
      '2..............................2',
      '2..............................2',
      '2..4444444......4444444........2',
      '2..4.....4......4.....4........2',
      '2..4.....4......4.....4........2',
      '2..4444444......4444444.....E..2',
      '2..............................2',
      '22222222222222222222222222222222',
    ],
    playerStart: { x: 15, y: 10, angle: 0 },
    enemies: [],
  },
  {
    name: 'Hangar Bay',
    map: [
      '33333333333333333333333333333333333333',
      '3....................................3',
      '3....................................3',
      '3....1111....2222....3333....4444....3',
      '3....1111....2222....3333....4444....3',
      '3....................................3',
      '3....................................3',
      '3....................................3',
      '3....................................3',
      '3........11111111111111111............3',
      '3........1...............1............3',
      '3........1...............1............3',
      '3........1...............1............3',
      '3........11111111111111111............3',
      '3....................................3',
      '3....................................3',
      '3....4444....3333....2222....1111....3',
      '3....4444....3333....2222....1111....3',
      '3....................................3',
      '3....................................3',
      '3...............................E....3',
      '33333333333333333333333333333333333333',
    ],
    playerStart: { x: 2, y: 2, angle: 0 },
    enemies: [],
  },
  {
    name: 'Underground Complex',
    map: [
      '44444444444444444444444444444444444444444444',
      '4..........................................4',
      '4..111..222..333..444..111..222..333..444..4',
      '4..........................................4',
      '4..........................................4',
      '4..222..............................222....4',
      '4..222..........1111111...........222....4',
      '4...............1.....1.................4',
      '4...............1.....1.................4',
      '4...............1111111.................4',
      '4..........................................4',
      '4..........................................4',
      '4........22222222222222222222............4',
      '4........2..................2............4',
      '4........2..................2............4',
      '4........2..................2............4',
      '4........22222222222222222222............4',
      '4..........................................4',
      '4..333..444..111..222..333..444..111..222..4',
      '4..........................................4',
      '4..........................................4',
      '4........................................E.4',
      '44444444444444444444444444444444444444444444',
    ],
    playerStart: { x: 3, y: 3, angle: 0 },
    enemies: [],
  },
  {
    name: 'Final Stand',
    map: [
      '1111111111111111111111111111111111111111111111111111',
      '1..................................................1',
      '1..................................................1',
      '1....2222....3333....4444....1111....2222....3333..1',
      '1....2222....3333....4444....1111....2222....3333..1',
      '1..................................................1',
      '1..................................................1',
      '1..................................................1',
      '1........111111111111111111111111111111..............1',
      '1........1............................1..............1',
      '1........1............................1..............1',
      '1........1............................1..............1',
      '1........1............................1..............1',
      '1........111111111111111111111111111111..............1',
      '1..................................................1',
      '1..................................................1',
      '1..................................................1',
      '1....3333....2222....1111....4444....3333....2222..1',
      '1....3333....2222....1111....4444....3333....2222..1',
      '1..................................................1',
      '1..................................................1',
      '1..................................................1',
      '1..................................................1',
      '1...............................................E..1',
      '1111111111111111111111111111111111111111111111111111',
    ],
    playerStart: { x: 25, y: 12, angle: 0 },
    enemies: [],
  },
];

export const LEVEL_COUNT = LEVELS.length;

export function loadLevel(index: number): ParsedLevel {
  const level = LEVELS[index % LEVELS.length];
  const tiles: number[][] = [];
  const exitTiles = new Set<string>();

  level.map.forEach((row, rowIndex) => {
    const rowTiles: number[] = [];
    for (let col = 0; col < row.length; col += 1) {
      const char = row[col];
      if (char === 'E') {
        rowTiles.push(0);
        exitTiles.add(`${col},${rowIndex}`);
      } else if (char === '#') {
        rowTiles.push(1);
      } else if (char >= '1' && char <= '4') {
        rowTiles.push(Number(char));
      } else {
        rowTiles.push(0);
      }
    }
    tiles.push(rowTiles);
  });

  return {
    name: level.name,
    tiles,
    width: tiles[0]?.length ?? 0,
    height: tiles.length,
    exitTiles,
    playerStart: level.playerStart,
    enemies: level.enemies.map(enemy => ({ ...enemy })),
  };
}
